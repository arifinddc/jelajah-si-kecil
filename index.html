<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Akademi Sage: Phi Brain Master</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        
        body, html { 
            margin: 0; padding: 0; 
            height: 100%; width: 100%;
            overflow: hidden; 
            font-family: 'Fredoka', sans-serif; 
            background: #0F172A;
            -webkit-user-select: none; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #root { height: 100%; width: 100%; }

        /* Container Utama dengan 100dvh untuk Mobile */
        .app-container {
            position: absolute; 
            inset: 0;
            height: 100dvh; /* Dynamic Height agar tidak terpotong address bar */
            display: flex; 
            flex-direction: column;
            background: linear-gradient(180deg, #1E293B 0%, #0F172A 100%);
            max-width: 500px; 
            margin: 0 auto;
            border-left: 2px solid #F59E0B; 
            border-right: 2px solid #F59E0B;
            /* Safe area untuk HP berponi */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* HUD di atas */
        .hud-bar {
            height: 60px; /* Diperkecil sedikit */
            flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 1rem; background: rgba(15, 23, 42, 0.95);
            border-bottom: 3px solid #F59E0B; z-index: 20;
        }

        /* Area Game Fleksibel */
        .game-area {
            flex: 1; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: space-evenly; /* Distribusi jarak otomatis */
            padding: 1rem; 
            width: 100%; 
            position: relative;
            overflow: hidden; /* Mencegah scroll yang tidak perlu */
        }

        /* Target Display (Responsive Size) */
        .target-wrapper {
            flex-shrink: 0; /* Jangan mengecil berlebihan */
            margin-bottom: 1rem;
            display: flex; justify-content: center; width: 100%;
        }

        .target-display {
            width: 25vh; max-width: 140px; aspect-ratio: 1; /* Responsive based on height */
            background: #1e293b; border: 4px dashed #64748b; border-radius: 1.5rem;
            display: flex; align-items: center; justify-content: center;
            font-size: 4rem; 
            animation: float 3s ease-in-out infinite;
        }
        .target-display.solid { border-style: solid; border-color: #F59E0B; background: #334155; }
        
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }

        /* Grid System (Responsive) */
        .option-grid { 
            display: grid; 
            gap: 10px; 
            width: 100%; 
            max-width: 360px;
            /* Agar tombol tidak terlalu tinggi di layar pendek */
            flex-grow: 0; 
        }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        
        .btn-choice {
            background: white; border: 4px solid #CBD5E1;
            border-radius: 1rem; 
            aspect-ratio: 1.2; /* Sedikit lebih gepeng agar muat vertikal */
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; transition: transform 0.1s;
            box-shadow: 0 4px 0 #94A3B8; color: #0F172A; 
            width: 100%;
        }
        .btn-choice:active { transform: scale(0.95); box-shadow: 0 2px 0 #94A3B8; }
        .btn-choice.correct { background: #4ADE80; border-color: #166534; box-shadow: 0 4px 0 #166534; }
        .btn-choice.wrong { background: #F87171; border-color: #991B1B; box-shadow: 0 4px 0 #991B1B; opacity: 0.5; }

        /* Special Puzzles */
        .sequence-row { display: flex; gap: 8px; background: #334155; padding: 10px; border-radius: 1rem; border: 2px solid #475569; }
        .seq-item { width: 45px; height: 45px; background: #1e293b; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; }
        
        .sudoku-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; background: #F59E0B; padding: 8px; border-radius: 1rem; }
        .sudoku-cell { width: 55px; height: 55px; background: #334155; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; font-size: 2rem; }
        
        .count-display { font-size: 3rem; text-align: center; line-height: 1.2; }

        .menu-btn {
            width: 100%; background: #F59E0B; color: white;
            padding: 1rem; margin-bottom: 0.8rem;
            border-radius: 1rem; font-size: 1.2rem; font-weight: bold;
            box-shadow: 0 4px 0 #B45309; transition: all 0.1s;
        }
        .menu-btn:active { transform: translateY(4px); box-shadow: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 1. GENERATOR DATABASE ---
        const generateDatabase = () => {
            const numbers = Array.from({length: 50}, (_, i) => ({ id: `n${i}`, icon: `${i}`, val: i, type: 'number' }));
            
            const emojis = [
                { i: "üê±", t: "animal" }, { i: "üê∂", t: "animal" }, { i: "ü¶Å", t: "animal" }, { i: "üê∏", t: "animal" }, { i: "üêî", t: "animal" },
                { i: "üçé", t: "food" }, { i: "üçå", t: "food" }, { i: "üçá", t: "food" }, { i: "üçâ", t: "food" }, { i: "üçì", t: "food" }, 
                { i: "üöó", t: "vehicle" }, { i: "üöÄ", t: "vehicle" }, { i: "üöå", t: "vehicle" }, { i: "üöì", t: "vehicle" },
                { i: "‚öΩ", t: "sport" }, { i: "üèÄ", t: "sport" }, { i: "üéæ", t: "sport" },
                { i: "üî¥", t: "color" }, { i: "üîµ", t: "color" }, { i: "üü°", t: "color" }, { i: "üü¢", t: "color" }
            ];

            const formattedEmojis = emojis.map((e, idx) => ({ id: `e${idx}`, icon: e.i, type: e.t }));
            return { numbers, emojis: formattedEmojis };
        };

        const DB = generateDatabase();

        const App = () => {
            const [screen, setScreen] = useState('menu');
            const [userData, setUserData] = useState(() => {
                const saved = localStorage.getItem('phi_sage_v14_1');
                return saved ? JSON.parse(saved) : { score: 0, lives: 3, levelIdx: 0, streak: 0, lastLifeLost: null };
            });

            const [puzzle, setPuzzle] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const [regenTimer, setRegenTimer] = useState("");

            // --- DIFFICULTY CONTROLLER ---
            const getDifficulty = (level) => {
                if (level < 5) return { maxNum: 10, types: ['match', 'shadow'], distractors: 1 };
                if (level < 15) return { maxNum: 20, types: ['match', 'shadow', 'count', 'sudoku'], distractors: 3 };
                if (level < 30) return { maxNum: 50, types: ['sequence', 'odd', 'count', 'sudoku'], distractors: 3 };
                return { maxNum: 50, types: ['sequence', 'odd', 'count', 'sudoku', 'match'], distractors: 3 };
            };

            // --- GAME LOGIC GENERATOR ---
            const generateMission = () => {
                const diff = getDifficulty(userData.levelIdx);
                const type = diff.types[Math.floor(Math.random() * diff.types.length)];
                
                let target, options = [], meta = {}, instruction = "";
                
                const getRand = (arr) => arr[Math.floor(Math.random() * arr.length)];
                const getDistractors = (arr, correctId, count) => arr.filter(a => a.id !== correctId).sort(()=>0.5-Math.random()).slice(0, count);

                if (type === 'match' || type === 'shadow') {
                    const pool = [...DB.emojis, ...DB.numbers.slice(0, diff.maxNum)];
                    target = getRand(pool);
                    options = [target, ...getDistractors(pool, target.id, diff.distractors)];
                    // FIX: Gunakan string biasa, jangan template literal dengan variabel undefined
                    instruction = type === 'match' ? "Cari yang sama persis!" : "Tebak bayangan siapa?";
                }
                else if (type === 'count') {
                    const num = Math.floor(Math.random() * (diff.maxNum > 10 ? 4 : 3)) + 1; 
                    const item = getRand(DB.emojis.filter(e => e.type !== 'color'));
                    const iconStr = Array(num).fill(item.icon).join(" ");
                    
                    target = { id: 'c_true', icon: iconStr, val: num }; 
                    const correctNum = DB.numbers.find(n => n.val === num);
                    options = [correctNum, ...getDistractors(DB.numbers.slice(1, 10), `n${num}`, diff.distractors)];
                    // FIX: {param} issue resolved here
                    instruction = `Ada berapa jumlahnya?`; 
                    meta = { isCounting: true, display: iconStr }; 
                }
                else if (type === 'sequence') {
                    if (Math.random() > 0.5) {
                        const start = Math.floor(Math.random() * (diff.maxNum - 3));
                        target = DB.numbers.find(n => n.val === start + 3);
                        meta = { seq: [start, start+1, start+2, "?"] };
                        options = [target, ...getDistractors(DB.numbers, target.id, diff.distractors)];
                    } else {
                        const a = getRand(DB.emojis);
                        const b = getRand(DB.emojis.filter(e => e.id !== a.id));
                        target = b;
                        meta = { seq: [a.icon, b.icon, a.icon, "?"] };
                        options = [b, ...getDistractors(DB.emojis, b.id, diff.distractors)];
                    }
                    instruction = "Apa urutan selanjutnya?";
                }
                else if (type === 'odd') {
                    const cat = getRand(['animal', 'food', 'vehicle', 'sport']);
                    const pool = DB.emojis.filter(e => e.type === cat);
                    const common = getRand(pool);
                    const odd = getRand(pool.filter(e => e.id !== common.id));
                    target = odd;
                    options = [common, common, common, odd]; 
                    instruction = "Mana yang paling beda?";
                }
                else if (type === 'sudoku') {
                    const pool = DB.emojis.filter(e => e.type === 'color').sort(()=>0.5-Math.random()).slice(0, 2);
                    const a = pool[0]; const b = pool[1];
                    target = b;
                    meta = { grid: [a.icon, b.icon, b.icon, "?"] };
                    options = [a, b];
                    instruction = "Warna kotak tidak boleh sama!";
                }

                setPuzzle({ type, target, options: options.sort(()=>0.5-Math.random()), meta, instruction });
            };

            // --- SYSTEM ---
            useEffect(() => {
                const timer = setInterval(() => {
                    if (userData.lives < 3 && userData.lastLifeLost) {
                        const diff = Date.now() - userData.lastLifeLost;
                        if (diff >= 600000) setUserData(p => ({ ...p, lives: Math.min(p.lives + 1, 3), lastLifeLost: p.lives+1<3?Date.now():null }));
                        else {
                            const rem = 600000 - diff;
                            setRegenTimer(`${Math.floor(rem/60000)}:${Math.floor((rem%60000)/1000).toString().padStart(2,'0')}`);
                        }
                    } else setRegenTimer("");
                }, 1000);
                return () => clearInterval(timer);
            }, [userData]);

            useEffect(() => { localStorage.setItem('phi_sage_v14_1', JSON.stringify(userData)); }, [userData]);

            const handleAnswer = (opt) => {
                if (feedback) return;
                const isCorrect = opt.id === puzzle.target.id;
                
                if (isCorrect) {
                    setFeedback('correct');
                    const newScore = userData.score + 10 + (userData.streak + 1 >= 5 ? 20 : 0);
                    setTimeout(() => {
                        setUserData(p => ({ ...p, score: newScore, levelIdx: p.levelIdx + 1, streak: p.streak + 1 }));
                        setScreen('result');
                        setFeedback(null);
                    }, 500); // Dipercepat transisinya
                } else {
                    setFeedback('wrong');
                    setUserData(p => ({ ...p, lives: Math.max(0, p.lives - 1), streak: 0, lastLifeLost: p.lives===3?Date.now():p.lastLifeLost }));
                    setTimeout(() => setFeedback(null), 800);
                }
            };

            // --- RENDERERS ---
            if (screen === 'menu') return (
                <div className="app-container p-6 justify-center items-center text-center">
                    <div className="text-8xl mb-4 animate-pulse">üß©</div>
                    <h1 className="text-3xl font-black text-white mb-2 tracking-tighter">AKADEMI SAGE</h1>
                    <p className="text-amber-500 mb-8 font-bold uppercase tracking-widest text-xs">Responsive v14.1</p>
                    
                    <button onClick={() => { setUserData({...userData, levelIdx: 0, score: 0, lives: 3}); setScreen('game'); setTimeout(generateMission, 100); }} className="menu-btn">
                        MULAI BARU
                    </button>
                    <button onClick={() => { setScreen('game'); setTimeout(generateMission, 100); }} className={`menu-btn secondary ${userData.levelIdx===0?'opacity-50':''}`}>
                        LANJUTKAN (Lv {userData.levelIdx + 1})
                    </button>
                    <div className="text-slate-500 text-xs mt-4">Lives: {userData.lives}/3 ‚Ä¢ {regenTimer}</div>
                </div>
            );

            if (screen === 'result') return (
                <div className="app-container p-6 justify-center items-center text-center bg-slate-900">
                    <div className="text-8xl mb-4 animate-bounce">üåü</div>
                    <h2 className="text-3xl font-bold text-white mb-2">HEBAT!</h2>
                    <p className="text-slate-400 mb-8">Level {userData.levelIdx + 1} Selesai</p>
                    <button onClick={() => { setScreen('game'); generateMission(); }} className="menu-btn bg-green-500 shadow-green-700">LANJUT</button>
                    <button onClick={() => setScreen('menu')} className="text-white underline mt-4">Menu Utama</button>
                </div>
            );

            return (
                <div className="app-container">
                    <div className="hud-bar">
                        <div className="flex flex-col items-center"><span className="text-2xl">‚ù§Ô∏è {userData.lives}</span><span className="text-[10px] text-amber-500">{regenTimer}</span></div>
                        <div className="text-center"><span className="text-xs text-slate-400 font-bold uppercase">Misi {userData.levelIdx + 1}</span></div>
                        <div className="bg-amber-500 text-white px-3 py-1 rounded-full font-bold text-sm">‚≠ê {userData.score}</div>
                    </div>

                    <div className="game-area">
                        {userData.lives <= 0 ? (
                            <div className="text-center">
                                <h2 className="text-2xl text-white font-bold mb-4">Istirahat Dulu!</h2>
                                <button onClick={() => setScreen('menu')} className="menu-btn">Ke Menu</button>
                            </div>
                        ) : puzzle ? (
                            <>
                                <h2 className="text-xl font-bold text-white mb-4 text-center leading-tight">
                                    {puzzle.instruction}
                                </h2>
                                
                                <div className="target-wrapper">
                                    {puzzle.type === 'sudoku' ? (
                                        <div className="sudoku-grid">{puzzle.meta.grid.map((c,i)=><div key={i} className="sudoku-cell">{c}</div>)}</div>
                                    ) : puzzle.type === 'sequence' ? (
                                        <div className="sequence-row">{puzzle.meta.seq.map((c,i)=><div key={i} className="seq-item text-white">{c}</div>)}</div>
                                    ) : puzzle.meta?.isCounting ? (
                                        <div className="target-display solid">
                                            <div className="count-display">{puzzle.meta.display}</div>
                                        </div>
                                    ) : (
                                        // FIX: Tanda Tanya '?' hanya muncul jika puzzle type bukan 'match'
                                        <div className={`target-display ${puzzle.type==='match'?'solid':''}`}>
                                            {puzzle.type === 'shadow' ? 
                                                <span className="grayscale brightness-0 opacity-20 text-6xl">{puzzle.target.icon}</span> : 
                                                // FIX: Jika 'Match', tampilkan icon target, bukan '?'
                                                (puzzle.type === 'match' ? <span className="text-6xl">{puzzle.target.icon}</span> : <span className="text-6xl animate-pulse">?</span>)
                                            }
                                        </div>
                                    )}
                                </div>

                                <div className={`option-grid ${puzzle.options.length > 2 ? 'grid-2' : ''}`}>
                                    {puzzle.options.map((opt, i) => (
                                        <button key={i} onClick={() => handleAnswer(opt)} 
                                            className={`btn-choice ${feedback==='correct' && opt.id===puzzle.target.id ? 'correct' : ''} ${feedback==='wrong' && opt.id!==puzzle.target.id ? 'wrong' : ''}`}>
                                            {opt.icon}
                                        </button>
                                    ))}
                                </div>
                            </>
                        ) : <div className="text-white">Memuat...</div>}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
