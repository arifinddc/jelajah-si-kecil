<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Jelajah Si Kecil</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        
        body, html { 
            margin: 0; padding: 0; 
            height: 100%; width: 100%;
            overflow: hidden; 
            font-family: 'Fredoka', sans-serif; 
            background: #0F172A;
            -webkit-user-select: none; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #root { height: 100%; width: 100%; }

        .app-container {
            position: absolute; inset: 0; height: 100dvh; 
            display: flex; flex-direction: column;
            background: linear-gradient(180deg, #1E293B 0%, #0F172A 100%);
            max-width: 500px; margin: 0 auto;
            border-left: 2px solid #F59E0B; border-right: 2px solid #F59E0B;
            padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
        }

        .hud-bar {
            height: 55px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 1rem; background: rgba(15, 23, 42, 0.95);
            border-bottom: 3px solid #F59E0B; z-index: 20;
        }

        .game-area {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: space-between;
            padding: 0.75rem; width: 100%; overflow: hidden;
        }

        .instruction-text {
            font-size: 1.1rem; font-weight: 700; color: #F1F5F9;
            line-height: 1.2; margin-bottom: 0.25rem; text-align: center;
        }

        /* Target Display */
        .target-wrapper {
            flex: 1; display: flex; align-items: center; justify-content: center;
            width: 100%; margin: 10px 0;
        }

        .target-display {
            width: 100px; height: 100px;
            background: #1e293b; border: 3px dashed #64748b; border-radius: 1.25rem;
            display: flex; align-items: center; justify-content: center;
            font-size: 3.5rem; 
        }
        .target-display.solid { border-style: solid; border-color: #F59E0B; background: #334155; }
        .target-display.hidden-target { display: none; } 

        /* Enhanced Maze Grid */
        .maze-container { display: flex; flex-direction: column; align-items: center; }
        .maze-arrows { 
            background: #334155; padding: 8px 16px; border-radius: 12px; margin-bottom: 12px;
            font-size: 1.8rem; border: 2px solid #64748b; color: #F59E0B;
            box-shadow: 0 4px 0 #1e293b; letter-spacing: 0.5rem;
        }
        .maze-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;
            background: #1E293B; padding: 8px; border-radius: 16px; border: 3px solid #475569;
        }
        .maze-cell {
            width: 40px; height: 40px; background: #0F172A; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
            color: #475569; font-weight: bold; border: 1px solid #334155;
        }
        .maze-cell.start { background: #F59E0B; color: white; border-color: #B45309; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }

        /* Option Grid */
        .option-grid { 
            display: grid; gap: 8px; width: 100%; max-width: 340px; margin-bottom: 0.5rem;
        }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        
        .btn-choice {
            background: white; border: 3px solid #CBD5E1; border-radius: 1rem; 
            aspect-ratio: 1.4; display: flex; align-items: center; justify-content: center;
            font-size: 2.2rem; transition: transform 0.1s;
            box-shadow: 0 4px 0 #94A3B8; color: #0F172A; width: 100%; position: relative;
        }
        .btn-choice:active { transform: scale(0.95); box-shadow: 0 1px 0 #94A3B8; }
        .grid-3 .btn-choice { aspect-ratio: 1.2; font-size: 1.8rem; }

        /* Feedback States */
        .btn-choice.correct { background: #4ADE80; border-color: #166534; box-shadow: 0 4px 0 #166534; }
        .btn-choice.wrong { background: #F87171; border-color: #991B1B; box-shadow: 0 4px 0 #991B1B; opacity: 0.8; animation: shake 0.3s; }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        .menu-btn {
            width: 100%; background: #F59E0B; color: white; padding: 1rem; margin-bottom: 0.8rem;
            border-radius: 1rem; font-size: 1.2rem; font-weight: bold;
            box-shadow: 0 4px 0 #B45309; transition: all 0.1s;
        }
        .menu-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #B45309; }

        .home-icon-btn {
            background: #334155; padding: 4px 8px; border-radius: 8px;
            font-size: 10px; font-weight: bold; color: #F59E0B; border: 1px solid #475569;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- DATABASE FIXED ---
        const generateDB = () => {
            const numbers = Array.from({length: 101}, (_, i) => ({ id: `n${i}`, icon: `${i}`, val: i, type: 'number' }));
            
            // Emoji List dengan ID Eksplisit agar tidak null
            const emojis = [
                { i: "üê±", t: "animal", id:"e_cat" }, { i: "üê∂", t: "animal", id:"e_dog" }, { i: "ü¶Å", t: "animal", id:"e_lion" }, { i: "üê∏", t: "animal", id:"e_frog" },
                { i: "üçé", t: "food", id:"e_apple" }, { i: "üçå", t: "food", id:"e_banana" }, { i: "üçá", t: "food", id:"e_grape" }, { i: "üçï", t: "food", id:"e_pizza" },
                { i: "üöó", t: "vehicle", id:"e_car" }, { i: "üöÄ", t: "vehicle", id:"e_rocket" }, { i: "‚úàÔ∏è", t: "vehicle", id:"e_plane" },
                { i: "‚öΩ", t: "sport", id:"e_ball" }, { i: "üèÄ", t: "sport", id:"e_basket" },
                { i: "üî¥", t: "color", id:"c_red" }, { i: "üîµ", t: "color", id:"c_blue" }, { i: "üü°", t: "color", id:"c_yellow" }, { i: "üü¢", t: "color", id:"c_green" },
                
                // Pairs Fixed (Two-way Reference)
                { i: "üåßÔ∏è", t: "weather", id:"e_rain", pair: "e_umbrella" }, { i: "üåÇ", t: "object", id:"e_umbrella", pair: "e_rain" },
                { i: "üîí", t: "object", id:"e_lock", pair: "e_key" }, { i: "üîë", t: "object", id:"e_key", pair: "e_lock" },
                { i: "ü¶∑", t: "body", id:"e_tooth", pair: "e_brush" }, { i: "ü™•", t: "object", id:"e_brush", pair: "e_tooth" },
                { i: "üëû", t: "clothes", id:"e_shoe", pair: "e_sock" }, { i: "üß¶", t: "clothes", id:"e_sock", pair: "e_shoe" }
            ];
            return { numbers, emojis };
        };

        const DB = generateDB();

        const App = () => {
            const [screen, setScreen] = useState('menu');
            const [userData, setUserData] = useState(() => {
                const saved = localStorage.getItem('jelajah_v18');
                return saved ? JSON.parse(saved) : { score: 0, lives: 3, levelIdx: 0, streak: 0, lastLifeLost: null };
            });
            const [puzzle, setPuzzle] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const [wrongId, setWrongId] = useState(null); // Track tombol yg salah
            const [regenTimer, setRegenTimer] = useState("");

            const getDifficulty = (level) => {
                if (level < 10) return { maxNum: 20, types: ['match', 'shadow', 'count', 'pair', 'maze'], options: 4 };
                if (level < 25) return { maxNum: 50, types: ['match', 'count', 'pair', 'maze', 'sequence', 'odd', 'sudoku'], options: 4 };
                return { maxNum: 100, types: ['match', 'count', 'pair', 'maze', 'sequence', 'odd', 'sudoku'], options: 6 };
            };

            const generateMission = () => {
                const diff = getDifficulty(userData.levelIdx);
                const type = diff.types[Math.floor(Math.random() * diff.types.length)];
                
                let target, options = [], meta = {}, instruction = "";
                const getRand = (arr) => arr[Math.floor(Math.random() * arr.length)];
                
                // SAFE DISTRACTOR GENERATOR
                const getDist = (arr, excludeIds, count) => {
                    // Filter item yang valid (tidak null/undefined) dan bukan target
                    const validItems = arr.filter(a => a && a.id && !excludeIds.includes(a.id));
                    return validItems.sort(()=>0.5-Math.random()).slice(0, count);
                };

                // 1. MATCH / SHADOW
                if (type === 'match' || type === 'shadow') {
                    const pool = [...DB.emojis, ...DB.numbers.slice(0, diff.maxNum)];
                    target = getRand(pool);
                    options = [target, ...getDist(pool, [target.id], diff.options - 1)];
                    instruction = type === 'match' ? "Cari yang sama persis!" : "Tebak bayangan siapa?";
                } 
                // 2. PAIRS (FIXED)
                else if (type === 'pair') {
                    const pairs = DB.emojis.filter(e => e.pair);
                    const q = getRand(pairs);
                    // Pastikan pairnya ada di DB
                    const ans = DB.emojis.find(e => e.id === q.pair);
                    
                    if (!ans) { // Fallback jika error, ganti ke match game
                        return generateMission(); 
                    }

                    target = ans;
                    meta = { display: q.icon };
                    options = [ans, ...getDist(DB.emojis, [q.id, ans.id], diff.options - 1)];
                    instruction = "Apa pasangannya?";
                }
                // 3. MAZE (Enhanced)
                else if (type === 'maze') {
                    const steps = diff.options > 4 ? 3 : 2; 
                    let pos = 0, pathIcons = [];
                    for(let i=0; i<steps; i++) {
                        const canGoRight = (pos % 3) !== 2;
                        const canGoDown = pos < 6;
                        if (canGoRight && canGoDown) {
                            if (Math.random() > 0.5) { pos += 1; pathIcons.push("‚û°Ô∏è"); } else { pos += 3; pathIcons.push("‚¨áÔ∏è"); }
                        } else if (canGoRight) { pos += 1; pathIcons.push("‚û°Ô∏è"); } 
                        else { pos += 3; pathIcons.push("‚¨áÔ∏è"); }
                    }
                    const labels = ["A","B","C","D","E","F","G","H","I"];
                    target = { id: `pos_${pos}`, icon: labels[pos] };
                    const wrongOpts = [0,1,2,3,4,5,6,7,8].filter(i => i !== pos).sort(()=>0.5-Math.random()).slice(0, diff.options - 1).map(i => ({ id: `pos_${i}`, icon: labels[i] }));
                    options = [target, ...wrongOpts];
                    instruction = "Ikuti panah! Kemana sampainya?";
                    meta = { isMaze: true, arrows: pathIcons, labels };
                }
                // 4. COUNT
                else if (type === 'count') {
                    const num = Math.floor(Math.random() * 5) + 1;
                    const item = getRand(DB.emojis.filter(e => e.type !== 'color'));
                    const iconStr = Array(num).fill(item.icon).join("");
                    target = { id: 'c_t', val: num };
                    const correctNumObj = DB.numbers.find(n => n.val === num);
                    options = [correctNumObj, ...getDist(DB.numbers.slice(1, 10), [`n${num}`], diff.options - 1)];
                    instruction = "Ada berapa jumlahnya?";
                    meta = { isCount: true, display: iconStr };
                }
                // 5. ODD
                else if (type === 'odd') {
                    const cat = getRand(['animal', 'food', 'vehicle']);
                    const pool = DB.emojis.filter(e => e.type === cat);
                    const common = getRand(pool);
                    const odd = getRand(pool.filter(e => e.id !== common.id));
                    target = odd;
                    options = [...Array(diff.options - 1).fill(common), odd];
                    instruction = "Mana yang paling beda?";
                }
                // 6. SUDOKU & SEQUENCE
                else if (type === 'sudoku') {
                    const cols = DB.emojis.filter(e => e.type === 'color').sort(()=>0.5-Math.random());
                    target = cols[1]; meta = { grid: [cols[0].icon, cols[1].icon, cols[1].icon, "?"] };
                    options = [cols[1], ...getDist(DB.emojis.filter(e => e.type === 'color'), [cols[1].id], diff.options - 1)];
                    instruction = "Warna kotak tidak boleh sama!";
                }
                else if (type === 'sequence') {
                    const a = getRand(DB.emojis); const b = getRand(DB.emojis.filter(e => e.id !== a.id));
                    target = b; meta = { seq: [a.icon, b.icon, a.icon, "?"] };
                    options = [b, ...getDist(DB.emojis, [a.id, b.id], diff.options - 1)];
                    instruction = "Apa urutan selanjutnya?";
                }

                // Final Check: Ensure no option is undefined
                if (options.some(o => !o || !o.icon)) return generateMission();

                setPuzzle({ type, target, options: options.sort(()=>0.5-Math.random()), meta, instruction });
            };

            // --- SYSTEM ---
            useEffect(() => {
                const timer = setInterval(() => {
                    if (userData.lives < 3 && userData.lastLifeLost) {
                        const diff = Date.now() - userData.lastLifeLost;
                        if (diff >= 600000) setUserData(p => ({ ...p, lives: Math.min(p.lives + 1, 3), lastLifeLost: p.lives+1<3?Date.now():null }));
                        else setRegenTimer(`${Math.floor((600000-diff)/60000)}:${Math.floor(((600000-diff)%60000)/1000).toString().padStart(2,'0')}`);
                    } else setRegenTimer("");
                }, 1000);
                return () => clearInterval(timer);
            }, [userData]);

            useEffect(() => { localStorage.setItem('jelajah_v18', JSON.stringify(userData)); }, [userData]);

            const handleAnswer = (opt) => {
                if (feedback === 'correct') return; // Prevent spam click on correct

                let isCorrect = false;
                if (puzzle.type === 'count') isCorrect = opt.val === puzzle.target.val;
                else if (puzzle.type === 'odd') isCorrect = opt.id === puzzle.target.id;
                else isCorrect = opt.id === puzzle.target.id;

                if (isCorrect) {
                    setFeedback('correct');
                    setWrongId(null); // Reset wrong state
                    setTimeout(() => {
                        setUserData(p => ({ ...p, score: p.score+10, levelIdx: p.levelIdx+1, streak: p.streak+1 }));
                        setScreen('result'); setFeedback(null);
                    }, 500);
                } else {
                    // Logic Fix: Hanya tandai tombol ini sebagai salah, JANGAN kasih tau yg benar
                    setWrongId(opt.id); 
                    setUserData(p => ({ ...p, lives: Math.max(0, p.lives-1), streak: 0, lastLifeLost: p.lives===3?Date.now():p.lastLifeLost }));
                    
                    // Hilangkan status merah setelah sebentar
                    setTimeout(() => setWrongId(null), 500);
                }
            };

            if (screen === 'menu') return (
                <div className="app-container p-6 justify-center items-center text-center">
                    <div className="text-7xl mb-4">üß©</div>
                    <h1 className="text-3xl font-black text-white mb-2 uppercase">Jelajah Si Kecil</h1>
                    <p className="text-amber-500 mb-8 font-bold uppercase tracking-widest text-[10px]">Edisi Fixed v18.0</p>
                    <button onClick={() => { setUserData({...userData, levelIdx:0, score:0, lives:3, streak:0, lastLifeLost:null}); setScreen('game'); setTimeout(generateMission, 50); }} className="menu-btn">MULAI BARU</button>
                    <button onClick={() => { setScreen('game'); setTimeout(generateMission, 50); }} className={`menu-btn bg-slate-700 ${userData.levelIdx===0?'opacity-50':''}`}>LANJUTKAN (Lv {userData.levelIdx+1})</button>
                    <div className="text-slate-500 text-xs mt-4">Energi: {userData.lives}/3 {regenTimer && `(${regenTimer})`}</div>
                </div>
            );

            if (screen === 'result') return (
                <div className="app-container p-6 justify-center items-center text-center bg-slate-900">
                    <div className="text-7xl mb-4">üåü</div>
                    <h2 className="text-2xl font-bold text-white mb-6">Hebat Sekali!</h2>
                    <button onClick={() => { setScreen('game'); generateMission(); }} className="menu-btn bg-green-600">LANJUT</button>
                    <button onClick={() => setScreen('menu')} className="text-slate-500 font-bold mt-2 uppercase text-xs">Ke Menu Utama</button>
                </div>
            );

            return (
                <div className="app-container">
                    <div className="hud-bar">
                        <div className="flex flex-col items-center"><span className="text-xl">‚ù§Ô∏è {userData.lives}</span><span className="text-[9px] text-amber-500">{regenTimer}</span></div>
                        <div className="flex flex-col items-center"><span className="text-[10px] text-slate-400 font-bold uppercase">Level {userData.levelIdx + 1}</span><button onClick={() => setScreen('menu')} className="home-icon-btn mt-1">üè† MENU</button></div>
                        <div className="bg-amber-500 text-white px-3 py-1 rounded-full font-bold text-sm">‚≠ê {userData.score}</div>
                    </div>
                    <div className="game-area">
                        {userData.lives <= 0 ? (
                            <div className="text-center"><h2 className="text-xl text-white font-bold mb-4">Energi Habis!</h2><button onClick={() => setScreen('menu')} className="menu-btn">Kembali</button></div>
                        ) : puzzle ? (
                            <>
                                <h2 className="instruction-text">{puzzle.instruction}</h2>
                                <div className="target-wrapper">
                                    {puzzle.type === 'sudoku' ? (
                                        <div className="grid grid-cols-2 gap-2 bg-amber-500 p-2 rounded-xl">{puzzle.meta.grid.map((c,i)=><div key={i} className="w-12 h-12 bg-slate-800 rounded-lg flex items-center justify-center text-2xl">{c}</div>)}</div>
                                    ) : puzzle.type === 'sequence' ? (
                                        <div className="flex gap-2 bg-slate-800 p-3 rounded-xl border border-slate-600">{puzzle.meta.seq.map((c,i)=><div key={i} className={`w-10 h-10 bg-slate-700 rounded-lg flex items-center justify-center text-xl text-white ${c==='?'?'animate-pulse text-amber-400':''}`}>{c}</div>)}</div>
                                    ) : puzzle.meta?.isCount ? (
                                        <div className="target-display solid text-3xl text-center px-2">{puzzle.meta.display}</div>
                                    ) : puzzle.meta?.isMaze ? (
                                        <div className="maze-container">
                                            <div className="maze-arrows">{puzzle.meta.arrows.join("  ")}</div>
                                            <div className="maze-grid">
                                                {puzzle.meta.labels.map((l,i) => <div key={i} className={`maze-cell ${i===0?'start':''}`}>{i===0?'üê±':l}</div>)}
                                            </div>
                                        </div>
                                    ) : puzzle.type === 'pair' ? (
                                        <div className="target-display solid">{puzzle.meta.display}</div>
                                    ) : (
                                        <div className={`target-display ${puzzle.type==='match'?'solid':''} ${puzzle.type==='odd'?'hidden-target':''}`}>
                                            {puzzle.type === 'shadow' ? <span className="grayscale brightness-0 opacity-10">{puzzle.target.icon}</span> : <span>{puzzle.target.icon}</span>}
                                        </div>
                                    )}
                                </div>
                                <div className={`option-grid ${puzzle.options.length > 4 ? 'grid-3' : 'grid-2'}`}>
                                    {puzzle.options.map((opt, i) => (
                                        <button key={i} onClick={() => handleAnswer(opt)} 
                                            /* LOGIC FEEDBACK FIX: Hanya nyalakan 'correct' jika feedback global 'correct'. Jika salah, nyalakan 'wrong' hanya pada tombol yg diklik */
                                            className={`btn-choice 
                                                ${feedback==='correct' && ((opt.id===puzzle.target.id) || (puzzle.type==='count' && opt.val===puzzle.target.val)) ? 'correct' : ''} 
                                                ${wrongId === opt.id ? 'wrong' : ''}
                                            `}>
                                            {opt.icon}
                                        </button>
                                    ))}
                                </div>
                            </>
                        ) : null}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
