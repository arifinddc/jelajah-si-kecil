<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Jelajah Si Kecil</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        
        body, html { 
            margin: 0; padding: 0; 
            height: 100%; width: 100%;
            overflow: hidden; 
            font-family: 'Fredoka', sans-serif; 
            background: #0F172A;
            -webkit-user-select: none; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #root { height: 100%; width: 100%; }

        .app-container {
            position: absolute; inset: 0; height: 100dvh; 
            display: flex; flex-direction: column;
            background: linear-gradient(180deg, #1E293B 0%, #0F172A 100%);
            max-width: 500px; margin: 0 auto;
            border-left: 2px solid #F59E0B; border-right: 2px solid #F59E0B;
            padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
        }

        .hud-bar {
            height: 55px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 1rem; background: rgba(15, 23, 42, 0.95);
            border-bottom: 3px solid #F59E0B; z-index: 20;
        }

        .game-area {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start;
            padding: 1rem; width: 100%; overflow-y: auto;
        }

        .instruction-text {
            font-size: 1.1rem; font-weight: 700; color: #F1F5F9;
            margin-bottom: 0.5rem; text-align: center;
        }

        /* MAZE STYLES */
        .maze-container { 
            display: flex; flex-direction: column; align-items: center; 
            width: 100%; flex: 1; justify-content: center;
        }

        .maze-arrows-box { 
            background: #334155; padding: 8px 12px; border-radius: 12px; margin-bottom: 15px;
            font-size: 1.6rem; border: 2px solid #64748b; color: #F59E0B;
            box-shadow: 0 4px 0 #1e293b; letter-spacing: 0.3rem; text-align: center;
            max-width: 95%; flex-wrap: wrap; display: flex; justify-content: center; gap: 5px;
        }

        .maze-grid {
            display: grid; gap: 4px;
            background: #1E293B; padding: 6px; border-radius: 16px; border: 3px solid #475569;
            margin-bottom: 1rem;
        }

        .maze-cell {
            width: 45px; height: 45px; background: #0F172A; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; font-size: 1.4rem;
            color: #64748B; font-weight: bold; border: 1px solid #334155;
            transition: all 0.2s; position: relative;
        }
        
        .grid-4x4 .maze-cell { width: 40px; height: 40px; font-size: 1.2rem; }
        .grid-5x5 .maze-cell { width: 34px; height: 34px; font-size: 1rem; }

        /* Style Kucing (Start) */
        .maze-cell.start { 
            background: #F59E0B; color: white; border-color: #B45309; 
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2); 
            z-index: 10;
        }

        /* Option Grid */
        .option-grid { 
            display: grid; gap: 8px; width: 100%; max-width: 360px; margin-top: auto;
        }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        
        .btn-choice {
            background: white; border: 3px solid #CBD5E1; border-radius: 1rem; 
            aspect-ratio: 1.5; display: flex; align-items: center; justify-content: center;
            font-size: 2rem; transition: transform 0.1s;
            box-shadow: 0 4px 0 #94A3B8; color: #0F172A; width: 100%; position: relative;
        }
        .btn-choice:active { transform: scale(0.95); box-shadow: 0 1px 0 #94A3B8; }
        
        .btn-choice.correct { background: #4ADE80; border-color: #166534; box-shadow: 0 4px 0 #166534; }
        .btn-choice.wrong { background: #F87171; border-color: #991B1B; box-shadow: 0 4px 0 #991B1B; opacity: 0.8; animation: shake 0.3s; }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        .menu-btn {
            width: 100%; background: #F59E0B; color: white; padding: 1rem; margin-bottom: 0.8rem;
            border-radius: 1rem; font-size: 1.2rem; font-weight: bold;
            box-shadow: 0 4px 0 #B45309; transition: all 0.1s;
        }
        .menu-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #B45309; }

        .home-icon-btn {
            background: #334155; padding: 4px 8px; border-radius: 8px;
            font-size: 10px; font-weight: bold; color: #F59E0B; border: 1px solid #475569;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [screen, setScreen] = useState('menu');
            const [userData, setUserData] = useState(() => {
                const saved = localStorage.getItem('jelajah_maze_v20');
                return saved ? JSON.parse(saved) : { score: 0, lives: 3, levelIdx: 0, streak: 0, lastLifeLost: null };
            });
            const [puzzle, setPuzzle] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const [wrongId, setWrongId] = useState(null);
            const [regenTimer, setRegenTimer] = useState("");

            // --- DIFFICULTY LOGIC ---
            const getDifficulty = (level) => {
                // Level 0-4: Grid 3x3, 2 Langkah
                if (level < 5) return { gridSize: 3, steps: 2, options: 2 };
                // Level 5-9: Grid 3x3, 3 Langkah
                if (level < 10) return { gridSize: 3, steps: 3, options: 3 };
                // Level 10-19: Grid 4x4, 3-4 Langkah
                if (level < 20) return { gridSize: 4, steps: Math.random() > 0.5 ? 3 : 4, options: 4 };
                // Level 20-29: Grid 4x4, 4-6 Langkah
                if (level < 30) return { gridSize: 4, steps: Math.floor(Math.random() * 3) + 4, options: 4 };
                // Level 30+: Grid 5x5, 5-8 Langkah
                return { gridSize: 5, steps: Math.floor(Math.random() * 4) + 5, options: 6 };
            };

            const generateMaze = () => {
                const diff = getDifficulty(userData.levelIdx);
                const size = diff.gridSize;
                const totalCells = size * size;
                const labels = "ABCDEFGHIJKLMNOPQRSTUVWXY".split("").slice(0, totalCells);
                
                // 1. Random Start Position
                const startPos = Math.floor(Math.random() * totalCells);
                
                let currentPos = startPos;
                let pathHistory = [startPos]; 
                let arrowSequence = [];

                for (let i = 0; i < diff.steps; i++) {
                    let possibleMoves = [];

                    // Cek batas tembok untuk setiap arah
                    // Kanan
                    if ((currentPos + 1) % size !== 0) {
                        if (pathHistory[pathHistory.length-2] !== currentPos + 1) possibleMoves.push({ move: 1, icon: '‚û°Ô∏è' });
                    }
                    // Bawah
                    if (currentPos + size < totalCells) {
                        if (pathHistory[pathHistory.length-2] !== currentPos + size) possibleMoves.push({ move: size, icon: '‚¨áÔ∏è' });
                    }
                    // Kiri
                    if (currentPos % size !== 0) {
                        if (pathHistory[pathHistory.length-2] !== currentPos - 1) possibleMoves.push({ move: -1, icon: '‚¨ÖÔ∏è' });
                    }
                    // Atas
                    if (currentPos - size >= 0) {
                        if (pathHistory[pathHistory.length-2] !== currentPos - size) possibleMoves.push({ move: -size, icon: '‚¨ÜÔ∏è' });
                    }

                    // Jika terjebak (dead end), berhenti di situ
                    if (possibleMoves.length === 0) break;

                    const selected = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
                    currentPos += selected.move;
                    pathHistory.push(currentPos);
                    arrowSequence.push(selected.icon);
                }

                const targetIndex = currentPos;
                const targetLabel = labels[targetIndex];

                // Options Generation
                const targetOption = { id: `pos_${targetIndex}`, icon: targetLabel, isTarget: true };
                
                const otherIndices = Array.from({length: totalCells}, (_, i) => i).filter(i => i !== targetIndex);
                const randomWrong = otherIndices.sort(() => 0.5 - Math.random()).slice(0, diff.options - 1);
                
                const wrongOptions = randomWrong.map(idx => ({
                    id: `pos_${idx}`,
                    icon: labels[idx],
                    isTarget: false
                }));

                const finalOptions = [targetOption, ...wrongOptions].sort(() => 0.5 - Math.random());

                setPuzzle({
                    gridSize: size,
                    labels: labels,
                    arrows: arrowSequence,
                    options: finalOptions,
                    targetId: targetOption.id,
                    startIndex: startPos // Start Posisi Random
                });
            };

            // --- SYSTEM ---
            useEffect(() => {
                const timer = setInterval(() => {
                    if (userData.lives < 3 && userData.lastLifeLost) {
                        const diff = Date.now() - userData.lastLifeLost;
                        if (diff >= 600000) setUserData(p => ({ ...p, lives: Math.min(p.lives + 1, 3), lastLifeLost: p.lives+1<3?Date.now():null }));
                        else setRegenTimer(`${Math.floor((600000-diff)/60000)}:${Math.floor(((600000-diff)%60000)/1000).toString().padStart(2,'0')}`);
                    } else setRegenTimer("");
                }, 1000);
                return () => clearInterval(timer);
            }, [userData]);

            useEffect(() => { localStorage.setItem('jelajah_maze_v20', JSON.stringify(userData)); }, [userData]);

            const handleAnswer = (opt) => {
                if (feedback === 'correct') return;

                if (opt.isTarget) {
                    setFeedback('correct');
                    setWrongId(null);
                    setTimeout(() => {
                        setUserData(p => ({ ...p, score: p.score+10, levelIdx: p.levelIdx+1, streak: p.streak+1 }));
                        setScreen('result'); setFeedback(null);
                    }, 500);
                } else {
                    setWrongId(opt.id);
                    setUserData(p => ({ ...p, lives: Math.max(0, p.lives-1), streak: 0, lastLifeLost: p.lives===3?Date.now():p.lastLifeLost }));
                    setTimeout(() => setWrongId(null), 500);
                }
            };

            if (screen === 'menu') return (
                <div className="app-container p-6 justify-center items-center text-center">
                    <div className="text-7xl mb-4">üß≠</div>
                    <h1 className="text-3xl font-black text-white mb-2 uppercase">Labirin Si Kecil</h1>
                    <p className="text-amber-500 mb-8 font-bold uppercase tracking-widest text-[10px]">Edisi Acak v20.0</p>
                    <button onClick={() => { setUserData({...userData, levelIdx:0, score:0, lives:3, streak:0, lastLifeLost:null}); setScreen('game'); setTimeout(generateMaze, 50); }} className="menu-btn">MULAI BARU</button>
                    <button onClick={() => { setScreen('game'); setTimeout(generateMaze, 50); }} className={`menu-btn bg-slate-700 ${userData.levelIdx===0?'opacity-50':''}`}>LANJUTKAN (Lv {userData.levelIdx+1})</button>
                    <div className="text-slate-500 text-xs mt-4">Energi: {userData.lives}/3 {regenTimer && `(${regenTimer})`}</div>
                </div>
            );

            if (screen === 'result') return (
                <div className="app-container p-6 justify-center items-center text-center bg-slate-900">
                    <div className="text-7xl mb-4">üåü</div>
                    <h2 className="text-2xl font-bold text-white mb-6">Luar Biasa!</h2>
                    <button onClick={() => { setScreen('game'); generateMaze(); }} className="menu-btn bg-green-600">LANJUT LEVEL</button>
                    <button onClick={() => setScreen('menu')} className="text-slate-500 font-bold mt-2 uppercase text-xs">Ke Menu Utama</button>
                </div>
            );

            return (
                <div className="app-container">
                    <div className="hud-bar">
                        <div className="flex flex-col items-center"><span className="text-xl">‚ù§Ô∏è {userData.lives}</span><span className="text-[9px] text-amber-500">{regenTimer}</span></div>
                        <div className="flex flex-col items-center"><span className="text-[10px] text-slate-400 font-bold uppercase">Level {userData.levelIdx + 1}</span><button onClick={() => setScreen('menu')} className="home-icon-btn mt-1">üè† MENU</button></div>
                        <div className="bg-amber-500 text-white px-3 py-1 rounded-full font-bold text-sm">‚≠ê {userData.score}</div>
                    </div>
                    <div className="game-area">
                        {userData.lives <= 0 ? (
                            <div className="text-center mt-20"><h2 className="text-xl text-white font-bold mb-4">Energi Habis!</h2><button onClick={() => setScreen('menu')} className="menu-btn">Kembali</button></div>
                        ) : puzzle ? (
                            <div className="maze-container w-full h-full">
                                <h2 className="instruction-text">Ikuti panah! Dimana Kucing sekarang?</h2>
                                
                                <div className="maze-arrows-box">
                                    {puzzle.arrows.map((a, i) => <span key={i}>{a}</span>)}
                                </div>

                                <div className={`maze-grid grid-${puzzle.gridSize}`} 
                                     style={{gridTemplateColumns: `repeat(${puzzle.gridSize}, 1fr)`}}>
                                    {puzzle.labels.map((l, i) => (
                                        <div key={i} className={`maze-cell ${i===puzzle.startIndex ? 'start' : ''} ${puzzle.gridSize===4?'text-sm':''} ${puzzle.gridSize===5?'text-xs':''}`}>
                                            {i===puzzle.startIndex ? 'üê±' : l}
                                        </div>
                                    ))}
                                </div>

                                <div className={`option-grid ${puzzle.options.length > 4 ? 'grid-cols-3' : 'grid-cols-2'}`}>
                                    {puzzle.options.map((opt, i) => (
                                        <button key={i} onClick={() => handleAnswer(opt)} 
                                            className={`btn-choice ${feedback==='correct' && opt.isTarget ? 'correct' : ''} ${wrongId === opt.id ? 'wrong' : ''}`}>
                                            {opt.icon}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ) : null}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
