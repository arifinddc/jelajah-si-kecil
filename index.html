<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Akademi Sage: Phi Brain Junior</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap');
        
        body, html { 
            margin: 0; padding: 0; 
            height: 100%; overflow: hidden; 
            font-family: 'Fredoka', sans-serif; 
            background: #0F172A; 
        }

        #root { height: 100%; }

        .game-container { 
            /* Menggunakan dvh agar tidak terpotong address bar browser HP */
            height: 100dvh; 
            max-width: 500px; 
            margin: 0 auto; 
            background: #1E293B; 
            display: flex; 
            flex-direction: column; 
            color: white; 
            position: relative; 
            border-left: 2px solid #F59E0B; 
            border-right: 2px solid #F59E0B;
            /* Support untuk notch iPhone */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .hud-bar { height: 70px; flex-shrink: 0; }
        .main-content { flex: 1; display: flex; flex-direction: column; justify-content: space-evenly; padding: 1rem; overflow: hidden; }

        /* Puzzle Elements */
        .sudoku-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; background: #F59E0B; padding: 10px; border-radius: 1.2rem; }
        .sudoku-cell { width: 65px; height: 65px; background: #334155; border-radius: 0.8rem; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; }
        
        .symmetry-box { width: 160px; height: 160px; background: #334155; border-radius: 1.5rem; overflow: hidden; border: 3px solid #475569; display: flex; align-items: center; justify-content: center; }
        .symmetry-half { font-size: 8rem; clip-path: inset(0 50% 0 0); transform: scale(1.4); }
        .symmetry-option { font-size: 3.5rem; clip-path: inset(0 0 0 50%); transform: scale(1.6) translateX(-25%); }

        .target-slot-container { flex: 1; display: flex; align-items: center; justify-content: center; max-height: 200px; }
        .target-slot { width: 130px; height: 130px; background: #222d3f; border: 3px dashed #475569; border-radius: 2rem; display: flex; align-items: center; justify-content: center; }

        .option-grid { display: grid; gap: 10px; width: 100%; padding-bottom: 10px; }
        .btn-choice { background: #334155; border: 3px solid #475569; border-radius: 1.2rem; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 2.8rem; transition: 0.2s; }
        .btn-choice:active { transform: scale(0.92); }
        .glow-gold { border-color: #F59E0B; box-shadow: 0 0 15px #F59E0B; background: #451a03; }

        button { touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const MASTER_DATA = {
            assets: [
                { id: "la", icon: "üÖ∞Ô∏è", name: "A", type: "letter" }, { id: "lb", icon: "üÖ±Ô∏è", name: "B", type: "letter" },
                { id: "n1", icon: "1Ô∏è‚É£", val: 1, type: "number" }, { id: "n2", icon: "2Ô∏è‚É£", val: 2, type: "number" },
                { id: "n3", icon: "3Ô∏è‚É£", val: 3, type: "number" },
                { id: "a1", icon: "üê±", name: "Kucing", type: "animal", sound: "Meong" },
                { id: "a2", icon: "üê∂", name: "Anjing", type: "animal", sound: "Guk Guk" },
                { id: "f1", icon: "üçé", name: "Apel", type: "food", color: "merah" },
                { id: "f2", icon: "üçå", name: "Pisang", type: "food", color: "kuning" },
                { id: "c1", icon: "üî¥", color: "merah", type: "color" }, { id: "c2", icon: "üîµ", color: "biru", type: "color" }
            ],
            schemas: ["phi_matching", "phi_shadow", "phi_symmetry", "phi_sudoku", "phi_sound", "phi_counting", "phi_sequence"]
        };

        const App = () => {
            const [gameState, setGameState] = useState('idle');
            const [userData, setUserData] = useState(() => {
                const saved = localStorage.getItem('phi_sage_v12');
                return saved ? JSON.parse(saved) : { score: 0, lives: 3, levelIdx: 0, streak: 0, lastLifeLost: null };
            });

            const [currentPuzzle, setCurrentPuzzle] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const [regenTimer, setRegenTimer] = useState("");

            const buildInstruction = (type, param) => {
                switch(type) {
                    case "phi_matching": return "Cari yang sama persis!";
                    case "phi_shadow":   return "Tebak bayangan siapa ini?";
                    case "phi_symmetry": return "Cari belahan yang cocok!";
                    case "phi_sudoku":   return "Warna kotak harus beda!";
                    case "phi_sound":    return `Siapa yang bunyinya ${param}?`;
                    case "phi_counting": return `Ketuk yang isinya ${param} benda!`;
                    case "phi_sequence": return `Apa angka setelah ini?`;
                    default: return "Selesaikan teka-tekinya!";
                }
            };

            const speak = (txt) => {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(txt);
                u.lang = 'id-ID'; u.rate = 0.9;
                window.speechSynthesis.speak(u);
            };

            const playTone = (isCorrect) => {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.frequency.setValueAtTime(isCorrect ? 880 : 220, ctx.currentTime);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    osc.start(); osc.stop(ctx.currentTime + 0.3);
                } catch(e) {}
            };

            useEffect(() => {
                const interval = setInterval(() => {
                    if (userData.lives < 3 && userData.lastLifeLost) {
                        const diff = Date.now() - userData.lastLifeLost;
                        if (diff >= 600000) {
                            setUserData(p => ({ ...p, lives: Math.min(p.lives + 1, 3), lastLifeLost: p.lives+1 < 3 ? Date.now() : null }));
                        } else {
                            const rem = 600000 - diff;
                            setRegenTimer(`${Math.floor(rem/60000)}:${Math.floor((rem%60000)/1000).toString().padStart(2,'0')}`);
                        }
                    } else setRegenTimer("");
                }, 1000);
                return () => clearInterval(interval);
            }, [userData.lives, userData.lastLifeLost]);

            useEffect(() => { localStorage.setItem('phi_sage_v12', JSON.stringify(userData)); }, [userData]);

            const nextMisi = () => {
                if (userData.lives <= 0) return speak("Energi habis, yuk istirahat.");
                
                const type = MASTER_DATA.schemas[Math.floor(Math.random() * MASTER_DATA.schemas.length)];
                const assets = MASTER_DATA.assets;
                let target, options = [], meta = {}, instrParam = "";

                if (type === "phi_sudoku") {
                    const colors = assets.filter(a => a.type === "color").sort(() => 0.5 - Math.random());
                    target = colors[0];
                    meta = { grid: [colors[0].icon, colors[1].icon, colors[1].icon, "?"] };
                    options = [colors[0], colors[1]];
                } 
                else if (type === "phi_sound") {
                    target = assets.filter(a => a.sound).sort(() => 0.5 - Math.random())[0];
                    instrParam = target.sound;
                    options = [target, ...assets.filter(a => a.id !== target.id).slice(0, 2)];
                }
                else if (type === "phi_counting") {
                    const count = Math.floor(Math.random() * 2) + 1;
                    instrParam = count;
                    target = { id: "correct", icon: Array(count).fill("üçé").join("") };
                    const wrong = { id: "wrong", icon: Array(count + 1).fill("üçé").join("") };
                    options = [target, wrong];
                }
                else if (type === "phi_sequence") {
                    const startNum = Math.floor(Math.random() * 2) + 1;
                    instrParam = "";
                    target = assets.find(a => a.val === startNum + 1 && a.type === "number");
                    meta = { seq: [startNum, startNum + 1, "?"] };
                    options = [target, assets.find(a => a.val === startNum && a.type === "number")].filter(Boolean);
                }
                else {
                    target = assets[Math.floor(Math.random() * assets.length)];
                    options = [target, ...assets.filter(a => a.id !== target.id).slice(0, 2)];
                }

                const instruction = buildInstruction(type, instrParam);
                setCurrentPuzzle({ type, target, options: options.sort(() => 0.5 - Math.random()), meta, instruction });
                setGameState('playing');
                speak(instruction);
            };

            const handleAnswer = (opt) => {
                if (feedback) return;
                const isCorrect = opt.id === currentPuzzle.target.id || (currentPuzzle.type === "phi_sequence" && opt.val === currentPuzzle.target.val);

                if (isCorrect) {
                    playTone(true); setFeedback('correct');
                    setTimeout(() => {
                        setUserData(p => ({ ...p, score: p.score + 10, levelIdx: p.levelIdx + 1 }));
                        setGameState('idle'); setFeedback(null);
                    }, 1200);
                } else {
                    playTone(false); setFeedback('wrong');
                    setUserData(p => ({ ...p, lives: Math.max(0, p.lives - 1), lastLifeLost: p.lives === 3 ? Date.now() : p.lastLifeLost }));
                    speak("Salah, coba lagi!");
                    setTimeout(() => setFeedback(null), 800);
                }
            };

            return (
                <div className="game-container">
                    <div className="hud-bar flex justify-between items-center px-4 bg-slate-900 border-b-2 border-amber-600">
                        <div className="flex flex-col items-center">
                            <span className="text-xl">‚ù§Ô∏è {userData.lives}</span>
                            <span className="text-[10px] text-amber-500 font-bold">{regenTimer}</span>
                        </div>
                        <div className="text-center font-bold text-slate-400 text-sm uppercase">Puzzle {userData.levelIdx + 1}</div>
                        <div className="bg-amber-600 px-3 py-1 rounded-full font-bold text-sm shadow-md">‚≠ê {userData.score}</div>
                    </div>

                    <div className="main-content">
                        {gameState === 'idle' && (
                            <div className="flex flex-col items-center">
                                <div className="text-7xl mb-6">üß©</div>
                                <h1 className="text-xl font-black text-amber-500 tracking-tighter mb-8 uppercase">Akademi Sage</h1>
                                <button onClick={nextMisi} className="bg-amber-600 text-white px-10 py-4 rounded-full text-xl font-bold shadow-2xl active:scale-90 transition-transform">PECAHKAN</button>
                            </div>
                        )}

                        {gameState === 'playing' && currentPuzzle && (
                            <>
                                <h2 className="text-lg font-bold text-slate-300 leading-tight">{currentPuzzle.instruction}</h2>
                                
                                <div className="target-slot-container">
                                    {currentPuzzle.type === "phi_sudoku" ? (
                                        <div className="sudoku-grid">
                                            {currentPuzzle.meta.grid.map((cell, i) => <div key={i} className="sudoku-cell">{cell}</div>)}
                                        </div>
                                    ) : currentPuzzle.type === "phi_symmetry" ? (
                                        <div className="symmetry-box"><span className="symmetry-half">{currentPuzzle.target.icon}</span></div>
                                    ) : currentPuzzle.type === "phi_sequence" ? (
                                        <div className="flex gap-2 bg-slate-800 p-4 rounded-xl border-2 border-slate-700">
                                            {currentPuzzle.meta.seq.map((s, i) => <span key={i} className="text-4xl font-bold text-amber-500">{s}</span>)}
                                        </div>
                                    ) : (
                                        <div className="target-slot">
                                            {currentPuzzle.type === "phi_shadow" ? 
                                                <span className="text-7xl grayscale brightness-0 opacity-10">{currentPuzzle.target.icon}</span> : 
                                                <span className="text-6xl animate-pulse">‚ùì</span>}
                                        </div>
                                    )}
                                </div>

                                <div className={`option-grid ${currentPuzzle.options.length > 2 ? 'grid-cols-2' : 'grid-cols-1 max-w-[200px] mx-auto'}`}>
                                    {currentPuzzle.options.map((opt, i) => (
                                        <button key={i} onClick={() => handleAnswer(opt)} 
                                            className={`btn-choice ${feedback === 'correct' && (opt.id === currentPuzzle.target.id || opt.val === currentPuzzle.target.val) ? 'glow-gold' : ''}`}>
                                            <span className={currentPuzzle.type === "phi_symmetry" ? 'symmetry-option' : ''}>{opt.icon}</span>
                                        </button>
                                    ))}
                                </div>
                            </>
                        )}
                    </div>
                    <div className="p-2 text-center text-[8px] text-slate-600 font-bold uppercase tracking-[0.2em]">Phi Brain Junior v12.3</div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
