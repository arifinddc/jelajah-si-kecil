<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Akademi Sage: Phi Brain Master</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        
        body, html { 
            margin: 0; padding: 0; 
            height: 100%; width: 100%;
            overflow: hidden; 
            font-family: 'Fredoka', sans-serif; 
            background: #0F172A;
            -webkit-user-select: none; user-select: none;
        }

        #root { height: 100%; width: 100%; }

        .app-container {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            background: linear-gradient(180deg, #1E293B 0%, #0F172A 100%);
            max-width: 500px; margin: 0 auto;
            border-left: 2px solid #F59E0B; border-right: 2px solid #F59E0B;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        /* HUD & Menu */
        .hud-bar {
            height: 70px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 1rem; background: rgba(15, 23, 42, 0.95);
            border-bottom: 3px solid #F59E0B; z-index: 20;
        }

        .menu-btn {
            width: 100%; background: #F59E0B; color: white;
            padding: 1rem; margin-bottom: 0.8rem;
            border-radius: 1rem; font-size: 1.2rem; font-weight: bold;
            box-shadow: 0 4px 0 #B45309; transition: all 0.1s;
        }
        .menu-btn:active { transform: translateY(4px); box-shadow: none; }
        .menu-btn.secondary { background: #334155; box-shadow: 0 4px 0 #1e293b; }

        /* Game Elements */
        .game-area {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 1rem; width: 100%; position: relative;
        }

        /* Target Display */
        .target-display {
            width: 140px; height: 140px;
            background: #1e293b; border: 4px dashed #64748b; border-radius: 2rem;
            display: flex; align-items: center; justify-content: center;
            font-size: 5rem; margin-bottom: 1.5rem;
            animation: float 3s ease-in-out infinite;
        }
        .target-display.solid { border-style: solid; border-color: #F59E0B; background: #334155; }
        
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        /* Grid System */
        .option-grid { display: grid; gap: 10px; width: 100%; max-width: 360px; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        
        .btn-choice {
            background: white; border: 4px solid #CBD5E1;
            border-radius: 1.2rem; aspect-ratio: 1;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; transition: transform 0.1s;
            box-shadow: 0 5px 0 #94A3B8; color: #0F172A; position: relative;
        }
        .btn-choice:active { transform: scale(0.95); box-shadow: 0 2px 0 #94A3B8; }
        .btn-choice.correct { background: #4ADE80; border-color: #166534; box-shadow: 0 5px 0 #166534; }
        .btn-choice.wrong { background: #F87171; border-color: #991B1B; box-shadow: 0 5px 0 #991B1B; opacity: 0.5; }

        /* Special Puzzles */
        .sequence-row { display: flex; gap: 8px; background: #334155; padding: 10px; border-radius: 1rem; margin-bottom: 1.5rem; border: 2px solid #475569; }
        .seq-item { width: 50px; height: 50px; background: #1e293b; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
        
        .sudoku-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; background: #F59E0B; padding: 8px; border-radius: 1rem; margin-bottom: 1.5rem; }
        .sudoku-cell { width: 60px; height: 60px; background: #334155; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; font-size: 2rem; }

        button { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 1. GENERATOR DATABASE MASIF (Procedural Generation) ---
        const generateDatabase = () => {
            const numbers = Array.from({length: 50}, (_, i) => ({ id: `n${i}`, icon: `${i}`, val: i, type: 'number' }));
            
            const emojis = [
                { i: "üê±", t: "animal" }, { i: "üê∂", t: "animal" }, { i: "ü¶Å", t: "animal" }, { i: "üêØ", t: "animal" }, { i: "üêÆ", t: "animal" }, { i: "üê∑", t: "animal" }, { i: "üê∏", t: "animal" }, { i: "üêµ", t: "animal" }, { i: "üêî", t: "animal" }, { i: "üêß", t: "animal" },
                { i: "üçé", t: "food" }, { i: "üçå", t: "food" }, { i: "üçá", t: "food" }, { i: "üçâ", t: "food" }, { i: "üçì", t: "food" }, { i: "üçí", t: "food" }, { i: "üçç", t: "food" }, { i: "ü••", t: "food" }, { i: "ü•ù", t: "food" }, { i: "ü•ë", t: "food" },
                { i: "üöó", t: "vehicle" }, { i: "üöï", t: "vehicle" }, { i: "üöô", t: "vehicle" }, { i: "üöå", t: "vehicle" }, { i: "üöì", t: "vehicle" }, { i: "üöë", t: "vehicle" }, { i: "üöí", t: "vehicle" }, { i: "üöú", t: "vehicle" }, { i: "üö≤", t: "vehicle" }, { i: "üöÄ", t: "vehicle" },
                { i: "‚öΩ", t: "sport" }, { i: "üèÄ", t: "sport" }, { i: "üèà", t: "sport" }, { i: "‚öæ", t: "sport" }, { i: "üéæ", t: "sport" }, { i: "üèê", t: "sport" }, { i: "üèâ", t: "sport" }, { i: "üé±", t: "sport" },
                { i: "‚åö", t: "object" }, { i: "üì±", t: "object" }, { i: "üíª", t: "object" }, { i: "üì∑", t: "object" }, { i: "üì∫", t: "object" }, { i: "üí°", t: "object" }, { i: "üî¶", t: "object" }, { i: "üíé", t: "object" },
                { i: "üî¥", t: "color" }, { i: "üîµ", t: "color" }, { i: "üü°", t: "color" }, { i: "üü¢", t: "color" }, { i: "üü£", t: "color" }, { i: "üü†", t: "color" }, { i: "‚ö´", t: "color" }, { i: "‚ö™", t: "color" }
            ];

            const formattedEmojis = emojis.map((e, idx) => ({ id: `e${idx}`, icon: e.i, type: e.t }));

            return { numbers, emojis: formattedEmojis };
        };

        const DB = generateDatabase();

        const App = () => {
            const [screen, setScreen] = useState('menu');
            const [userData, setUserData] = useState(() => {
                const saved = localStorage.getItem('phi_sage_v14');
                return saved ? JSON.parse(saved) : { score: 0, lives: 3, levelIdx: 0, streak: 0, lastLifeLost: null };
            });

            const [puzzle, setPuzzle] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const [regenTimer, setRegenTimer] = useState("");

            // --- DIFFICULTY CONTROLLER ---
            const getDifficulty = (level) => {
                // Level 1-5: Intro (Angka 0-10, Objek simpel)
                if (level < 5) return { maxNum: 10, types: ['match', 'shadow'], distractors: 1 };
                // Level 6-15: Basic (Angka 0-20, Counting, Sudoku)
                if (level < 15) return { maxNum: 20, types: ['match', 'shadow', 'count', 'sudoku'], distractors: 3 };
                // Level 16-30: Intermediate (Sequence, Odd One Out)
                if (level < 30) return { maxNum: 50, types: ['sequence', 'odd', 'count', 'sudoku'], distractors: 3 };
                // Level 30+: Master (Semua tipe, Angka besar)
                return { maxNum: 50, types: ['sequence', 'odd', 'count', 'sudoku', 'match'], distractors: 3 };
            };

            // --- GAME LOGIC GENERATOR ---
            const generateMission = () => {
                const diff = getDifficulty(userData.levelIdx);
                const type = diff.types[Math.floor(Math.random() * diff.types.length)];
                
                let target, options = [], meta = {}, instruction = "";
                
                // Helper: Ambil random item
                const getRand = (arr) => arr[Math.floor(Math.random() * arr.length)];
                const getDistractors = (arr, correctId, count) => arr.filter(a => a.id !== correctId).sort(()=>0.5-Math.random()).slice(0, count);

                if (type === 'match' || type === 'shadow') {
                    // Cari Sama / Bayangan
                    const pool = [...DB.emojis, ...DB.numbers.slice(0, diff.maxNum)];
                    target = getRand(pool);
                    options = [target, ...getDistractors(pool, target.id, diff.distractors)];
                    instruction = type === 'match' ? "Cari yang sama persis!" : "Tebak bayangan siapa?";
                }
                else if (type === 'count') {
                    // Berhitung
                    const num = Math.floor(Math.random() * (diff.maxNum > 10 ? 5 : 3)) + 1; // Count max 5 items for display
                    const item = getRand(DB.emojis.filter(e => e.type !== 'color'));
                    const iconStr = Array(num).fill(item.icon).join(" ");
                    
                    target = { id: 'c_true', icon: iconStr, val: num }; // Visual representation
                    // Options are numbers
                    const correctNum = DB.numbers.find(n => n.val === num);
                    options = [correctNum, ...getDistractors(DB.numbers.slice(1, 10), `n${num}`, diff.distractors)];
                    instruction = "Ada berapa jumlahnya?";
                    meta = { isCounting: true, display: iconStr }; // Special flag
                }
                else if (type === 'sequence') {
                    // Pola Angka atau Benda
                    if (Math.random() > 0.5) {
                        // Angka: 1 2 3 ?
                        const start = Math.floor(Math.random() * (diff.maxNum - 3));
                        target = DB.numbers.find(n => n.val === start + 3);
                        meta = { seq: [start, start+1, start+2, "?"] };
                        options = [target, ...getDistractors(DB.numbers, target.id, diff.distractors)];
                    } else {
                        // Pola: A B A ?
                        const a = getRand(DB.emojis);
                        const b = getRand(DB.emojis.filter(e => e.id !== a.id));
                        target = b;
                        meta = { seq: [a.icon, b.icon, a.icon, "?"] };
                        options = [b, ...getDistractors(DB.emojis, b.id, diff.distractors)];
                    }
                    instruction = "Apa urutan selanjutnya?";
                }
                else if (type === 'odd') {
                    // Cari yang beda: 3 Kucing, 1 Anjing
                    const cat = getRand(['animal', 'food', 'vehicle', 'sport']);
                    const pool = DB.emojis.filter(e => e.type === cat);
                    
                    const common = getRand(pool);
                    const odd = getRand(pool.filter(e => e.id !== common.id));
                    
                    target = odd;
                    options = [common, common, common, odd]; 
                    instruction = "Mana yang paling beda?";
                }
                else if (type === 'sudoku') {
                    // Sudoku 2x2 Warna/Benda
                    const pool = DB.emojis.filter(e => e.type === 'color').sort(()=>0.5-Math.random()).slice(0, 2);
                    const a = pool[0]; const b = pool[1];
                    target = b;
                    meta = { grid: [a.icon, b.icon, b.icon, "?"] };
                    options = [a, b];
                    instruction = "Warna kotak tidak boleh sama!";
                }

                setPuzzle({ type, target, options: options.sort(()=>0.5-Math.random()), meta, instruction });
            };

            // --- SYSTEM ---
            useEffect(() => {
                const timer = setInterval(() => {
                    if (userData.lives < 3 && userData.lastLifeLost) {
                        const diff = Date.now() - userData.lastLifeLost;
                        if (diff >= 600000) setUserData(p => ({ ...p, lives: Math.min(p.lives + 1, 3), lastLifeLost: p.lives+1<3?Date.now():null }));
                        else {
                            const rem = 600000 - diff;
                            setRegenTimer(`${Math.floor(rem/60000)}:${Math.floor((rem%60000)/1000).toString().padStart(2,'0')}`);
                        }
                    } else setRegenTimer("");
                }, 1000);
                return () => clearInterval(timer);
            }, [userData]);

            useEffect(() => { localStorage.setItem('phi_sage_v14', JSON.stringify(userData)); }, [userData]);

            const handleAnswer = (opt) => {
                if (feedback) return;
                const isCorrect = opt.id === puzzle.target.id;
                
                if (isCorrect) {
                    setFeedback('correct');
                    const newScore = userData.score + 10 + (userData.streak + 1 >= 5 ? 20 : 0);
                    setTimeout(() => {
                        setUserData(p => ({ ...p, score: newScore, levelIdx: p.levelIdx + 1, streak: p.streak + 1 }));
                        setScreen('result');
                        setFeedback(null);
                    }, 800);
                } else {
                    setFeedback('wrong');
                    setUserData(p => ({ ...p, lives: Math.max(0, p.lives - 1), streak: 0, lastLifeLost: p.lives===3?Date.now():p.lastLifeLost }));
                    setTimeout(() => setFeedback(null), 800);
                }
            };

            // --- SCREENS ---
            if (screen === 'menu') return (
                <div className="app-container p-6 justify-center items-center text-center">
                    <div className="text-8xl mb-4 animate-pulse">üß©</div>
                    <h1 className="text-4xl font-black text-white mb-2 tracking-tighter">AKADEMI SAGE</h1>
                    <p className="text-amber-500 mb-8 font-bold uppercase tracking-widest text-xs">Infinite Puzzle v14.0</p>
                    
                    <button onClick={() => { setUserData({...userData, levelIdx: 0, score: 0, lives: 3}); setScreen('game'); setTimeout(generateMission, 100); }} className="menu-btn">
                        MULAI BARU
                    </button>
                    <button onClick={() => { setScreen('game'); setTimeout(generateMission, 100); }} className={`menu-btn secondary ${userData.levelIdx===0?'opacity-50':''}`}>
                        LANJUTKAN (Lv {userData.levelIdx + 1})
                    </button>
                    <div className="text-slate-500 text-xs mt-4">Lives: {userData.lives}/3 ‚Ä¢ {regenTimer}</div>
                </div>
            );

            if (screen === 'result') return (
                <div className="app-container p-6 justify-center items-center text-center bg-slate-900">
                    <div className="text-8xl mb-4 animate-bounce">üåü</div>
                    <h2 className="text-3xl font-bold text-white mb-2">HEBAT!</h2>
                    <p className="text-slate-400 mb-8">Kamu naik ke Level {userData.levelIdx + 1}</p>
                    <button onClick={() => { setScreen('game'); generateMission(); }} className="menu-btn bg-green-500 shadow-green-700">LANJUT</button>
                    <button onClick={() => setScreen('menu')} className="text-white underline mt-4">Menu Utama</button>
                </div>
            );

            return (
                <div className="app-container">
                    <div className="hud-bar">
                        <div className="flex flex-col items-center"><span className="text-2xl">‚ù§Ô∏è {userData.lives}</span><span className="text-[10px] text-amber-500">{regenTimer}</span></div>
                        <div className="text-center"><span className="text-xs text-slate-400 font-bold uppercase">Misi {userData.levelIdx + 1}</span></div>
                        <div className="bg-amber-500 text-white px-3 py-1 rounded-full font-bold text-sm">‚≠ê {userData.score}</div>
                    </div>

                    <div className="game-area">
                        {userData.lives <= 0 ? (
                            <div className="text-center">
                                <h2 className="text-2xl text-white font-bold mb-4">Istirahat Dulu!</h2>
                                <button onClick={() => setScreen('menu')} className="menu-btn">Ke Menu</button>
                            </div>
                        ) : puzzle ? (
                            <>
                                <h2 className="text-xl font-bold text-white mb-6 text-center">{puzzle.instruction}</h2>
                                
                                <div className="mb-6 flex justify-center w-full">
                                    {puzzle.type === 'sudoku' ? (
                                        <div className="sudoku-grid">{puzzle.meta.grid.map((c,i)=><div key={i} className="sudoku-cell">{c}</div>)}</div>
                                    ) : puzzle.type === 'sequence' ? (
                                        <div className="sequence-row">{puzzle.meta.seq.map((c,i)=><div key={i} className="seq-item text-white">{c}</div>)}</div>
                                    ) : puzzle.meta?.isCounting ? (
                                        <div className="text-center bg-slate-800 p-4 rounded-2xl border-2 border-slate-600">
                                            <div className="text-4xl mb-2">{puzzle.meta.display}</div>
                                        </div>
                                    ) : (
                                        <div className={`target-display ${puzzle.type==='match'?'solid':''}`}>
                                            {puzzle.type === 'shadow' ? 
                                                <span className="grayscale brightness-0 opacity-20 text-6xl">{puzzle.target.icon}</span> : 
                                                <span className="text-6xl">{puzzle.target.icon}</span>}
                                        </div>
                                    )}
                                </div>

                                <div className={`option-grid ${puzzle.options.length > 2 ? 'grid-2' : ''}`}>
                                    {puzzle.options.map((opt, i) => (
                                        <button key={i} onClick={() => handleAnswer(opt)} 
                                            className={`btn-choice ${feedback==='correct' && opt.id===puzzle.target.id ? 'correct' : ''} ${feedback==='wrong' && opt.id!==puzzle.target.id ? 'wrong' : ''}`}>
                                            {opt.icon}
                                        </button>
                                    ))}
                                </div>
                            </>
                        ) : <div className="text-white">Memuat...</div>}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
